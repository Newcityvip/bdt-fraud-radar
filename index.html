<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BDT Fraud Radar</title>

  <style>
    :root { color-scheme: light; }
    body { font-family: Arial, sans-serif; margin: 0; background: #fff; color:#111; }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1 { font-size: 28px; margin: 0; display:flex; align-items:center; gap:10px; }
    .badge { font-size: 12px; padding: 4px 8px; border:1px solid #ddd; border-radius:999px; color:#333; }
    .actions { display:flex; align-items:center; gap:10px; }
    button {
      border:1px solid #ccc; background:#fff; padding:10px 14px;
      border-radius:10px; cursor:pointer;
    }
    button:hover { background:#f6f6f6; }
    .status { color:#b42318; font-weight:600; margin-right:10px; }
    .filters { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; margin-top: 16px; }
    label { font-size: 12px; color:#444; display:block; margin-bottom:6px; }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border:1px solid #ccc;
      border-radius: 10px;
      outline:none;
      font-size:14px;
    }
    .tableWrap { margin-top: 16px; border:1px solid #ddd; border-radius: 12px; overflow:auto; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    thead th {
      background:#f7f7f7;
      text-align:left;
      padding: 10px;
      border-bottom:1px solid #ddd;
      white-space:nowrap;
    }
    tbody td { padding: 10px; border-bottom:1px solid #eee; vertical-align: top; }
    tbody tr:hover { background:#fafafa; }
    .pill {
      display:inline-block; padding: 3px 8px; border-radius:999px; font-size: 12px;
      border:1px solid #ddd;
    }
    .pill.low { background:#ecfdf3; border-color:#a6f4c5; }
    .pill.med { background:#fffaeb; border-color:#fedf89; }
    .pill.high { background:#fef3f2; border-color:#fda29b; }
    .muted { color:#666; }
    .small { font-size:12px; color:#666; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1>ðŸš¨ BDT Fraud Radar <span class="badge">Fast (No JSONP)</span></h1>

      <div class="actions">
        <span class="status" id="statusText"></span>
        <button id="reloadBtn">Reload</button>
        <button id="exportBtn">Export CSV</button>
      </div>
    </div>

    <div class="filters">
      <div>
        <label>Min Risk Score</label>
        <input id="minScore" type="number" value="3" min="0" />
      </div>

      <div>
        <label>Risk Level</label>
        <select id="riskLevel">
          <option value="ALL">ALL</option>
          <option value="LOW">LOW</option>
          <option value="MED">MED</option>
          <option value="HIGH">HIGH</option>
        </select>
      </div>

      <div>
        <label>Search Username</label>
        <input id="searchUser" placeholder="type username..." />
      </div>
    </div>

    <div class="small" style="margin-top:10px;">
      Tip: This dashboard loads data in pages (300 rows per page) to avoid timeout.
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Last Activity</th>
            <th>Risk Score</th>
            <th>Risk Level</th>
            <th>Reasons</th>
            <th>Total Deposit</th>
            <th>Total Withdrawal</th>
            <th>Net</th>
            <th>Deposit Cnt</th>
            <th>Withdraw Cnt</th>
            <th>Unique Banks</th>
            <th>Shared Bank Users</th>
            <th>Shared IP Users</th>
            <th>Fast Withdraw?</th>
            <th>Account Status</th>
            <th>VIP</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // âœ… YOUR API URL
    const API_BASE = "https://script.google.com/macros/s/AKfycbwxfjB-XCs5wq1Non1eB3KNEq5gN-mGJTZzGPC-vpzYCgMLWx1JDIkVH3Gjrs-VQ6lWGA/exec";

    const $ = (id) => document.getElementById(id);

    let allRows = [];
    let offset = 0;
    const LIMIT = 300;

    function setStatus(msg, isError=false){
      const el = $("statusText");
      if (!el) return;
      el.style.color = isError ? "#b42318" : "#027a48";
      el.textContent = msg || "";
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function buildUrl(params){
      const u = new URL(API_BASE);
      Object.entries(params).forEach(([k,v]) => {
        if (v !== undefined && v !== null && v !== "") u.searchParams.set(k, v);
      });
      return u.toString();
    }

    async function fetchJson(url){
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    function pill(level){
      const lv = (level || "").toUpperCase();
      const cls = lv === "HIGH" ? "high" : (lv === "MED" ? "med" : "low");
      return `<span class="pill ${cls}">${escapeHtml(lv || "LOW")}</span>`;
    }

    function applyClientFilters(rows){
      const minScore = parseInt($("minScore").value || "0", 10);
      const riskLevel = ($("riskLevel").value || "ALL").toUpperCase();
      const q = ($("searchUser").value || "").trim().toLowerCase();

      return rows.filter(r => {
        const rs = Number(r.riskScore || 0);
        if (rs < minScore) return false;

        if (riskLevel !== "ALL" && (String(r.riskLevel || "").toUpperCase() !== riskLevel)) return false;

        if (q && !String(r.username || "").toLowerCase().includes(q)) return false;

        return true;
      });
    }

    function renderTable(){
      const tbody = $("tableBody");
      if(!tbody) return;
      const rows = applyClientFilters(allRows);

      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.username)}</td>
          <td>${escapeHtml(r.lastActivityAt || "")}</td>
          <td><b>${escapeHtml(r.riskScore)}</b></td>
          <td>${pill(r.riskLevel)}</td>
          <td class="muted">${escapeHtml(r.reasons || "")}</td>
          <td>${escapeHtml(r.totalDeposit)}</td>
          <td>${escapeHtml(r.totalWithdrawal)}</td>
          <td>${escapeHtml(r.net)}</td>
          <td>${escapeHtml(r.depositCnt)}</td>
          <td>${escapeHtml(r.withdrawCnt)}</td>
          <td>${escapeHtml(r.uniqueBanks)}</td>
          <td>${escapeHtml(r.sharedBankUsers)}</td>
          <td>${escapeHtml(r.sharedIpUsers)}</td>
          <td>${escapeHtml(r.fastWithdraw)}</td>
          <td>${escapeHtml(r.accountStatus)}</td>
          <td>${escapeHtml(r.vip)}</td>
        `;
        tbody.appendChild(tr);
      });

      setStatus(`Loaded ${allRows.length} rows (showing ${rows.length})`, false);
    }

    async function loadAllPages(){
      offset = 0;
      allRows = [];
      renderTable();

      const minScore = parseInt($("minScore").value || "3", 10);

      setStatus("Loading...", false);

      while(true){
        const url = buildUrl({
          format: "json",
          minScore,
          days: 3,        // âœ… fixed days = 3 (change later if needed)
          limit: LIMIT,
          offset
        });

        const data = await fetchJson(url);

        if(!data || data.ok !== true){
          throw new Error(data?.error || "API error");
        }

        const rows = Array.isArray(data.rows) ? data.rows : [];
        allRows = allRows.concat(rows);
        offset += rows.length;

        renderTable();

        if(!data.has_more) break;
      }

      setStatus(`DONE âœ… Total ${allRows.length} rows`, false);
    }

    function exportCSV(){
      const rows = applyClientFilters(allRows);

      const headers = [
        "username","lastActivityAt",
        "riskScore","riskLevel","reasons","totalDeposit","totalWithdrawal","net",
        "depositCnt","withdrawCnt","uniqueBanks","sharedBankUsers","sharedIpUsers",
        "fastWithdraw","accountStatus","vip"
      ];

      const lines = [];
      lines.push(headers.join(","));

      rows.forEach(r=>{
        const line = headers.map(h=>{
          const v = String(r[h] ?? "");
          return `"${v.replaceAll('"','""')}"`;
        }).join(",");
        lines.push(line);
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bdt_fraud_radar.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // âœ… events
    window.addEventListener("DOMContentLoaded", () => {
      $("reloadBtn").addEventListener("click", () => {
        loadAllPages().catch(err => setStatus("Error: " + err.message, true));
      });

      $("exportBtn").addEventListener("click", exportCSV);

      $("minScore").addEventListener("input", renderTable);
      $("riskLevel").addEventListener("change", renderTable);
      $("searchUser").addEventListener("input", renderTable);

      // auto load on open
      loadAllPages().catch(err => setStatus("Error: " + err.message, true));
    });
  </script>
</body>
</html>
